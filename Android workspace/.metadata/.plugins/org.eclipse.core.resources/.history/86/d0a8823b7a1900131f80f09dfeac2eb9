package com.markbuikema.juliana32.sections;

import android.graphics.Bitmap;
import android.text.Html;
import android.text.method.LinkMovementMethod;
import android.text.util.Linkify;
import android.view.LayoutInflater;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.ImageButton;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.TextView;

import com.markbuikema.juliana32.R;
import com.markbuikema.juliana32.activities.MainActivity;
import com.markbuikema.juliana32.model.FacebookNieuwsItem;
import com.markbuikema.juliana32.model.NieuwsItem;
import com.markbuikema.juliana32.model.NormalNieuwsItem;
import com.markbuikema.juliana32.model.TeaserNieuwsItem;
import com.markbuikema.juliana32.tools.FacebookHelper.CommentLoader;
import com.markbuikema.juliana32.tools.PhotoSharer;
import com.markbuikema.juliana32.tools.PictureRetriever;
import com.markbuikema.juliana32.tools.Tools;

public class NieuwsDetail {

	private static final String TAG = "NieuwsDetail";

	private static final String NEW_LINE = "NEWLINEREFERENCE1337";

	private MainActivity act;
	private NieuwsItem item;

	private TextView title;
	private TextView subTitle;
	private TextView date;
	private ImageView logo;
	private ImageButton comments;

	private LinearLayout photoContainer;

	private TextView content;

	public NieuwsDetail(final MainActivity act, final NieuwsItem item) {
		this.act = act;
		this.item = item;

		View mainView = act.findViewById(R.id.nieuwsDetailView);

		title = (TextView) mainView.findViewById(R.id.nieuwsDetailTitle);
		subTitle = (TextView) mainView.findViewById(R.id.nieuwsDetailSubtitle);
		content = (TextView) mainView.findViewById(R.id.nieuwsContent);
		date = (TextView) mainView.findViewById(R.id.nieuwsDetailDate);
		logo = (ImageView) mainView.findViewById(R.id.nieuwsDetailIcon);
		comments = (ImageButton) act.findViewById(R.id.menuComments);

		title.setText(item.getTitle());

		if (item.getSubTitle() == null)
			subTitle.setVisibility(View.GONE);
		else
			subTitle.setText(Html.fromHtml("<i>" + item.getSubTitle() + "</i>"));

		comments.setOnClickListener(new OnClickListener() {

			@Override
			public void onClick(View v) {
				
				String id = ((FacebookNieuwsItem)item).getFbId();
				new CommentLoader().execute(id);

			}
		});

		String contentString = item.getContent();
		if (contentString == null)
			contentString = "error";
		contentString = contentString.replaceAll(NEW_LINE, "\n");
		contentString = contentString.replaceAll(Character.toString((char) 65532), "");

		content.setText(android.text.Html.fromHtml(contentString.replace("\n", "<br />")));
		content.setMovementMethod(LinkMovementMethod.getInstance());

		if (item instanceof NormalNieuwsItem)
			date.setText(Tools.getDateString(((NormalNieuwsItem) item).getCreatedAt()));

		if (item.isFromFacebook()) {
			content.setAutoLinkMask(Linkify.ALL);
			logo.setImageBitmap(Tools.getFacebookLogo(act));
		} else
			logo.setImageBitmap(Tools.getJulianaLogo(act));

		photoContainer = (LinearLayout) act.getPhotoDrawerView().findViewById(R.id.newsPhotoContainer);
		populatePhotos();
	}

	private void populatePhotos() {
		photoContainer.removeAllViews();

		for (int i = 0; i < item.getPhotoCount(); i++) {
			final String url = item.getPhoto(i);
			View view = LayoutInflater.from(act).inflate(R.layout.photo_item, null);
			final ImageView image = (ImageView) view.findViewById(R.id.photoView);
			final ImageButton shareButton = (ImageButton) view.findViewById(R.id.photoShareButton);

			shareButton.setOnClickListener(new OnClickListener() {

				@Override
				public void onClick(View v) {
					new PhotoSharer(act).execute(url, item.getTitle());
				}
			});
			new PictureRetriever() {
				@Override
				protected void onPostExecute(Bitmap result) {
					image.setImageBitmap(result);
					shareButton.setVisibility(View.VISIBLE);
				};

			}.execute(url);
			view.setPadding(15, 15, 15, 15);
			photoContainer.addView(view);
		}
	}

	public String getTitle() {
		return item.getTitle();
	}

	public String getDetailUrl() {
		if (item instanceof NormalNieuwsItem)
			return ((NormalNieuwsItem) item).getDetailUrl();
		else
			if (item instanceof TeaserNieuwsItem)
				return ((TeaserNieuwsItem) item).getDetailUrl();
			else
				return null;
	}

	public boolean hasPhotos() {
		return item.getPhotoCount() > 0;
	}

}