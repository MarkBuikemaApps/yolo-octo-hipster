package com.markbuikema.juliana32.sections;

import static com.markbuikema.juliana32.tools.Tools.getHttpContent;

import java.util.ArrayList;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import android.app.Activity;
import android.content.Context;
import android.os.AsyncTask;
import android.util.Log;
import android.view.LayoutInflater;
import android.view.View;
import android.view.ViewGroup;
import android.widget.ArrayAdapter;
import android.widget.ListView;
import android.widget.TextView;

import com.markbuikema.juliana32.R;
import com.markbuikema.juliana32.activities.MainActivity;
import com.markbuikema.juliana32.model.Game;
import com.markbuikema.juliana32.model.Season;
import com.markbuikema.juliana32.model.Team;
import com.markbuikema.juliana32.model.Team.Category;

public class Teams {
	
	private final static String TAG = "Teams";

	private final static String INFORMATION_URL = MainActivity.BASE_SERVER_URL + "/seasons/get/all";

	private Activity activity;
	private ListView teamsList;
	private ArrayAdapter<TeamListItem> adapter;
	private ArrayList<Season> seasons;

	public Teams(Activity act) {
		this.activity = act;
		View mainView = activity.findViewById(R.id.teams);
		teamsList = (ListView) mainView.findViewById(R.id.teams_list);
		adapter = new TeamAdapter(activity);
		teamsList.setAdapter(adapter);
		seasons = new ArrayList<Season>();

		
		new InformationRetriever().execute();
	}

	private class InformationRetriever extends AsyncTask<Void, Season, Void> {

		@Override
		protected Void doInBackground(Void... params) {
			String json = getHttpContent(INFORMATION_URL);
			try {
				JSONObject base = new JSONObject(json);
				try {
					JSONArray seasons = base.getJSONArray("seasons");
					for (int i = 0; i < seasons.length(); i++) {
						publishProgress(processSeasonJSON(seasons.getJSONObject(i)));
					}
				} catch (JSONException e) {
					JSONObject season = base.getJSONObject("seasons");
					publishProgress(processSeasonJSON(season));
				}
			} catch (JSONException e) {
				e.printStackTrace();
			}
			return null;
		}

		private Season processSeasonJSON(JSONObject seasonJSON) {
			Season season = null;
			try {
				int year = seasonJSON.getInt("year");
				season = new Season(year);

				try {
					JSONArray seasonTeams = seasonJSON.getJSONArray("teams");
					for (int i = 0; i < seasonTeams.length(); i++) {
						season.addTeam(processTeamJSON(seasonTeams.getJSONObject(i)));
					}
				} catch (JSONException e) {
					JSONObject seasonTeam = seasonJSON.getJSONObject("teams");
					season.addTeam(processTeamJSON(seasonTeam));
				}
			} catch (JSONException e) {
				e.printStackTrace();
			}
			Log.d(TAG, season.toString());
			return season;

		}

		private Team processTeamJSON(JSONObject teamJSON) {
			Team team = null;
			try {
				int id = teamJSON.getInt("id");
				String name = teamJSON.getString("name");
				Category category = Category.valueOf(teamJSON.getString("category"));

				team = new Team(id, name, category);

				try {
					JSONArray games = teamJSON.getJSONArray("games");
					for (int i = 0; i < games.length(); i++) {
						team.addGame(processGameJSON(games.getJSONObject(i)));
					}
				} catch (JSONException e) {
					JSONObject game = teamJSON.getJSONObject("games");
					team.addGame(processGameJSON(game));
				}

			} catch (JSONException e) {
				e.printStackTrace();
			}
			return team;
		}

		private Game processGameJSON(JSONObject gameJSON) {
			Game game = null;
			try {
				int id = gameJSON.getInt("id");
				String teamName = gameJSON.getString("teamName");
				String otherTeam = gameJSON.getString("otherTeam");
				boolean home = gameJSON.getBoolean("home");
				long date = gameJSON.getLong("date");
				int teamGoals = gameJSON.getInt("teamGoals");
				int otherGoals = gameJSON.getInt("otherGoals");

				game = new Game(id, teamName, otherTeam, home, date, teamGoals, otherGoals);
			} catch (JSONException e) {
				e.printStackTrace();
			}
			return game;
		}

		@Override
		protected void onProgressUpdate(Season... values) {
			for (Season season : values)
				seasons.add(season);
		}
		
		
	}

	private class TeamAdapter extends ArrayAdapter<TeamListItem> {

		private int teamId = 0;

		public TeamAdapter(Context context) {
			super(context, 0);

			add("Senioren", true);
			add("Juliana 1", false);
			add("Juliana 2", false);
			add("Juliana 3", false);
			add("Juliana 4", false);
			add("Juliana 5", false);
			add("Juliana 6", false);
			add("Juliana 7", false);
			add("Jeugd", true);
			add("Juliana B1", false);
			add("Juliana C1", false);
			add("Juliana C2", false);
			add("Juliana D1", false);
			add("Juliana E1", false);
			add("Juliana E2", false);
			add("Juliana F1", false);
			add("Dames", true);
			add("Juliana DA1", false);

		}

		private void add(String text, boolean isCaption) {
			add(new TeamListItem(getContext(), isCaption, text, isCaption ? -1 : (teamId++)));
		}

		@Override
		public View getView(int position, View convertView, ViewGroup parent) {

			convertView = getItem(position).getView();

			TextView text = (TextView) convertView.findViewById(R.id.teamText);
			text.setText(getItem(position).getTitle());

			return convertView;
		}

		@Override
		public boolean isEnabled(int position) {
			return !getItem(position).isCaption();
		}

		@Override
		public int getViewTypeCount() {
			return 2;
		}
	}

	private class TeamListItem {
		private boolean caption;
		private String title;
		private int teamId;
		private View view;

		public TeamListItem(Context context, boolean caption, String title, int teamId) {
			this.caption = caption;
			this.title = title;
			this.teamId = teamId;

			view = LayoutInflater.from(context).inflate(caption ? R.layout.listitem_caption : R.layout.listitem_team, null);

		}

		public boolean isCaption() {
			return caption;
		}

		public View getView() {
			return view;
		}

		public String getTitle() {
			return title;
		}

		public int getTeamId() {
			return teamId;
		}
	}

}
